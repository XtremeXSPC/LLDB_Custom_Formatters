<!DOCTYPE html>
<html>
  <head>
    <title>Interactive Graph Visualizer</title>
    <style>
      /* Injected styles start */
      __SHARED_CSS__
      /* Injected styles end */
  
      /* Fallback/base styles to maintain syntax highlighting */
      body {
        padding: 0;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <!-- UI Controls -->
    <button
      id="toggle-info-btn"
      onclick="toggleInfoBox()"
      title="Toggle Info Panel"
    >
      ⚙️
    </button>

    <div id="info-box" class="hidden">
      <h3>Graph Controls</h3>

      <div class="theme-controls">
        <button id="theme-toggle-btn" onclick="toggleTheme()">
          Switch to Light Theme
        </button>
      </div>

      <!-- View Operations -->
      <div class="controls-section">
        <div class="section-title">View Operations</div>
        <div class="button-group">
          <button id="btn-center" class="button" onclick="centerView()">
            Center
          </button>
          <button id="btn-clear" class="button" onclick="clearSelection()">
            Clear
          </button>
        </div>
      </div>

      <!-- Layout Controls -->
      <div class="controls-section layout-controls">
        <div class="section-title">Layout</div>
        <div class="button-group">
          <button
            class="button active"
            onclick="setLayout('physics')"
            id="physics-btn"
          >
            Physics
          </button>
          <button
            class="button"
            onclick="setLayout('hierarchical')"
            id="hierarchical-btn"
          >
            Hierarchical
          </button>
          <button class="button" onclick="setLayout('radial')" id="radial-btn">
            Radial
          </button>
        </div>
      </div>

      <!-- Search Controls -->
      <div class="controls-section search-controls">
        <div class="section-title">Search & Highlight</div>
        <input
          type="text"
          class="search-box"
          id="search-input"
          placeholder="Search node values..."
          oninput="searchNodes(this.value)"
        />
        <div class="button-group" style="margin-top: 8px">
          <button class="button" onclick="clearHighlights()">
            Clear Search
          </button>
        </div>
      </div>

      <!-- Statistics and Node Info -->
      <div class="stats-display" id="stats-display">
        <div class="section-title">Graph Statistics</div>
        <div id="graph-stats"></div>
      </div>

      <div class="node-info" id="node-info" style="display: none">
        <div class="section-title">Selected Node</div>
        <div id="node-details"></div>
      </div>

      <!-- Connected Nodes Section -->
      <div class="connected-nodes" id="connected-nodes" style="display: none">
        <div class="section-title">Connected Nodes</div>
        <div id="connected-list"></div>
      </div>

      <!-- Legend -->
      <div class="legend">
        <div class="section-title">Legend</div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #7aa2f7"></div>
          <span>Normal</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #bb9af7"></div>
          <span>Selected</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #f7768e"></div>
          <span>Search</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #e0af68"></div>
          <span>Connected</span>
        </div>
      </div>

      <!-- Export Controls -->
      <div class="controls-section export-controls">
        <div class="section-title">Export</div>
        <div class="button-group">
          <button id="btn-png" class="button" onclick="exportPNG()">PNG</button>
          <button id="btn-json" class="button" onclick="customExportJSON()">
            JSON
          </button>
        </div>
      </div>
    </div>

    <!-- Vis.js Container -->
    <div id="mynetwork"></div>

    <!-- Scripts -->
    <script type="text/javascript">
      // Include the vis.js library (this would be a file include in a real scenario)
      __VISJS_LIBRARY__;
    </script>
    <script type="text/javascript">
      // Common JS functions will be injected here by Python
      __SHARED_JS__;
    </script>
    <script type="text/javascript">
      // ----- Data from Python ----- //
      const rawNodesData = __NODES_DATA__;
      const rawEdgesData = __EDGES_DATA__;

      // ----- Vis.js Setup ----- //
      let network;
      let currentLayout = "physics";

      // Process raw data into vis.js format
      const processedNodes = rawNodesData.map((node) => ({
        id: node.id,
        label: String(node.label),
        title: node.title,
        originalData: node,
      }));

      const nodes = new vis.DataSet(processedNodes);
      const edges = new vis.DataSet(rawEdgesData);
      const data = { nodes: nodes, edges: edges };
      const container = document.getElementById("mynetwork");

      // ----- Layout & Base Options ----- //
      const layoutConfigs = {
        physics: {
          physics: {
            enabled: true,
            barnesHut: {
              gravitationalConstant: -8000,
              centralGravity: 0.1,
              springLength: 150,
              springConstant: 0.05,
              nodeDistance: 100,
              damping: 0.05,
            },
          },
        },
        hierarchical: {
          layout: {
            hierarchical: {
              enabled: true,
              sortMethod: "hubsize",
              direction: "UD",
              nodeSpacing: 150,
              levelSeparation: 170,
            },
          },
          physics: { enabled: false },
        },
        radial: {
          layout: { randomSeed: 2 },
          physics: {
            enabled: true,
            barnesHut: {
              gravitationalConstant: -5000,
              centralGravity: 0.25,
              springLength: 120,
              nodeDistance: 100,
            },
          },
        },
      };

      const baseOptions = {
        interaction: {
          hover: true,
          tooltipDelay: 200,
          selectConnectedEdges: false,
        },
        nodes: {
          shape: "box",
          shapeProperties: { borderRadius: 6 },
          margin: 12,
          font: {
            color: colorPalette.textDefault,
            size: 16,
            face: "arial",
            bold: { color: colorPalette.textDefault },
          },
          borderWidth: 2,
          color: {
            border: colorPalette.nodeBorder,
            background: colorPalette.nodeDefault,
            highlight: {
              border: colorPalette.nodeSelectedBorder,
              background: colorPalette.nodeSelected,
            },
            hover: {
              border: colorPalette.nodeHover,
              background: colorPalette.nodeHover,
            },
          },
          shadow: {
            enabled: true,
            color: "rgba(0, 0, 0, 0.5)",
            size: 20,
            x: 5,
            y: 5,
          },
        },
        edges: {
          arrows: { to: { enabled: true, scaleFactor: 1 } },
          width: 2,
          color: {
            color: colorPalette.edgeDefault,
            highlight: colorPalette.edgeSelected,
            inherit: false,
            opacity: 0.9,
          },
          smooth: { type: "dynamic" },
        },
      };

      // ----- Graph-Specific Functions ----- //

      /**
       * Creates or recreates the network with a specified layout.
       * @param {string} layoutType - The key for the layout configuration ('physics', 'hierarchical', etc.).
       */
      function createNetwork(layoutType) {
        const options = { ...baseOptions, ...layoutConfigs[layoutType] };
        if (network) network.destroy();
        network = new vis.Network(container, data, options);

        // Attach event listeners
        network.on("click", handleNodeClick);
        network.on("hoverNode", handleNodeHover);
        network.on("blurNode", handleNodeBlur);
        network.on("stabilizationIterationsDone", updateStats);
        updateStats(); // Initial call
      }

      /**
       * Changes the network layout and recreates the visualization.
       * @param {string} layoutType - The new layout to apply.
       */
      function setLayout(layoutType) {
        currentLayout = layoutType;
        document
          .querySelectorAll(".layout-controls button")
          .forEach((btn) => btn.classList.remove("active"));
        document.getElementById(`${layoutType}-btn`).classList.add("active");
        createNetwork(layoutType);
      }

      /**
       * Handles clicks on nodes to highlight them and their connections.
       */
      function handleNodeClick(params) {
        resetColors();
        hideConnectedNodes();

        if (params.nodes.length > 0) {
          const selectedNodeId = params.nodes[0];

          // Highlight selected node
          nodes.update({
            id: selectedNodeId,
            color: {
              background: colorPalette.nodeSelected,
              border: colorPalette.nodeSelectedBorder,
            },
          });

          // Highlight connected nodes and edges
          const connectedEdges = network.getConnectedEdges(selectedNodeId);
          edges.update(
            connectedEdges.map((edgeId) => ({
              id: edgeId,
              color: { color: colorPalette.edgeSelected },
            }))
          );

          const connectedNodes = network.getConnectedNodes(selectedNodeId);
          nodes.update(
            connectedNodes.map((nodeId) => ({
              id: nodeId,
              color: {
                background: colorPalette.nodeHighlighted,
                border: colorPalette.nodeHighlightedBorder,
              },
            }))
          );

          showNodeInfo(nodes.get(selectedNodeId));
          showConnectedNodes(selectedNodeId, connectedNodes);
        } else {
          hideNodeInfo();
          hideConnectedNodes();
        }
      }

      /**
       * Displays information about the selected node.
       */
      function showNodeInfo(nodeData) {
        const infoDiv = document.getElementById("node-info");
        const detailsDiv = document.getElementById("node-details");
        const connections = network.getConnectedEdges(nodeData.id).length;
        detailsDiv.innerHTML = `<strong>Label:</strong> ${nodeData.label}<br><strong>ID:</strong> ${nodeData.id}<br><strong>Connections:</strong> ${connections}`;
        infoDiv.style.display = "block";
      }

      /**
       * Displays the list of connected nodes.
       * @param {string} selectedNodeId - The ID of the selected node.
       * @param {Array} connectedNodeIds - Array of connected node IDs.
       */
      function showConnectedNodes(selectedNodeId, connectedNodeIds) {
        const connectedDiv = document.getElementById("connected-nodes");
        const listDiv = document.getElementById("connected-list");

        if (connectedNodeIds.length === 0) {
          listDiv.innerHTML = "<em>No connected nodes</em>";
        } else {
          const connectedNodesData = connectedNodeIds.map((id) =>
            nodes.get(id)
          );
          const nodesList = connectedNodesData
            .map(
              (node) =>
                `<div class="connected-node-item">${node.label} (ID: ${node.id})</div>`
            )
            .join("");
          listDiv.innerHTML = nodesList;
        }

        connectedDiv.style.display = "block";
      }

      /**
       * Hides the connected nodes section.
       */
      function hideConnectedNodes() {
        const connectedDiv = document.getElementById("connected-nodes");
        if (connectedDiv) {
          connectedDiv.style.display = "none";
        }
      }

      /**
       * Updates the statistics panel with current graph metrics.
       */
      function updateStats() {
        const statsDiv = document.getElementById("graph-stats");
        const nodeCount = nodes.length;
        const edgeCount = edges.length;
        const avgDegree =
          nodeCount > 0 ? ((2 * edgeCount) / nodeCount).toFixed(2) : 0;
        statsDiv.innerHTML = `<strong>Nodes:</strong> ${nodeCount}<br><strong>Edges:</strong> ${edgeCount}<br><strong>Avg. Degree:</strong> ${avgDegree}<br><strong>Layout:</strong> ${currentLayout}`;
      }

      /**
       * Prepares graph data and calls the shared JSON export function.
       */
      function customExportJSON() {
        const graphData = {
          nodes: nodes.get(),
          edges: edges.get(),
          layout: currentLayout,
          timestamp: new Date().toISOString(),
        };
        exportJSON(graphData, "graph-data.json");
      }

      // ----- Initialisation ----- //
      createNetwork(currentLayout);
    </script>
  </body>
</html>
